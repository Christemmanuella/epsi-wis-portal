<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EPSI-WIS Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #0a192f, #1e3a8a);
      color: #ffffff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .header {
      background: #2B1C4D;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .header .logo-container img {
      height: 60px;
      margin: 0 10px;
      transition: transform 0.3s ease;
    }
    .header .logo-container img:hover {
      transform: scale(1.1);
    }
    .profile-initials {
      height: 120px;
      width: 120px;
      background: #00ffcc;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2B1C4D;
      font-weight: bold;
      font-size: 2em;
      transition: transform 0.3s ease;
      margin: 0 auto 10px auto;
    }
    .profile-initials:hover {
      transform: scale(1.1);
    }
    .navbar {
      background: #2B1C4D;
      padding: 0;
    }
    .navbar-nav .nav-link {
      color: #ffffff !important;
      font-weight: 600;
      margin: 0 15px;
      transition: color 0.3s ease;
    }
    .navbar-nav .nav-link:hover {
      color: #00ffcc !important;
    }
    .section {
      padding: 40px 20px;
      animation: fadeIn 1s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #00ffcc;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 255, 204, 0.3);
    }
    .btn-custom {
      background: linear-gradient(45deg, #00ffcc, #ff00ff);
      color: #2B1C4D;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    .btn-custom:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #ff00ff, #00ffcc);
    }
    .error {
      color: #ff4d4d;
      font-size: 0.9em;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .profile-img {
      max-width: 150px;
      border-radius: 50%;
      border: 3px solid #00ffcc;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    .profile-img:hover {
      transform: rotate(5deg) scale(1.1);
    }
    #profileSection .form-group {
      margin-bottom: 15px;
    }
    #dashboardSection, #profileSection {
      min-height: 80vh;
    }
    .animated-text {
      animation: slideIn 1s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .dashboard-band {
      background: rgba(0, 255, 204, 0.1);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 5px solid #00ffcc;
    }
    .dashboard-band ul {
      list-style-type: none;
      padding: 0;
      color: #ffffff;
    }
    .dashboard-band ul li {
      margin: 10px 0;
      font-size: 1.1em;
    }
    .profile-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .profile-table th, .profile-table td {
      border: 1px solid #00ffcc;
      padding: 10px;
      text-align: left;
      color: #ffffff;
    }
    .profile-table th {
      background: rgba(0, 255, 204, 0.2);
    }
    .profile-initials-container {
      text-align: center;
      margin-bottom: 0;
    }
    .profile-name {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
      color: #ffffff;
    }
    label, h2, h3, h4, h5, p, a {
      color: #ffffff !important;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 80%;
      max-width: 400px;
      background-color: #000000;
      color: #ffffff;
    }
  </style>
</head>
<body>
  <div class="header" id="header" style="display: none;">
    <div class="logo-container">
      <img src="/static/assets/epsi_logo.png" alt="EPSI Logo">
      <img src="/static/assets/wis_logo.png" alt="WIS Logo" style="height: 60px;">
    </div>
    <div id="profileImageHeader" class="profile-initials" style="margin-right: 20px;"></div>
    <nav class="navbar navbar-expand-lg">
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#" id="homeLink">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="profileLink">Profil</a></li>
          <li class="nav-item"><a class="nav-link" href="#" id="logout">D√©connexion</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="container mt-5 section" id="registerSection" style="display: block;">
    <div class="card">
      <h2 class="text-center mb-4 animated-text">Bienvenue sur le portail EPSI WIS</h2>
      <h2 class="text-center mb-4 animated-text">Inscription</h2>
      <form id="registerForm">
        <div class="mb-3">
          <label class="form-label">Formation</label>
          <select class="form-select" id="formation" name="formation" required>
            <option value="">Choisir une formation</option>
            <option value="ASRBD">ASRBD</option>
            <option value="EISI">EISI</option>
            <option value="DEVIA">DEVIA</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Email EPSI/WIS</label>
          <input type="email" class="form-control" id="email" name="email" required>
          <div id="emailError" class="error"></div>
        </div>
        <button type="submit" class="btn btn-custom w-100">Suivant</button>
        <a href="#" class="btn btn-outline-light mt-2 w-100" id="loginLink">D√©j√† inscrit ? Connectez-vous</a>
      </form>
    </div>
  </div>

  <div class="container mt-5 section" id="loginSection" style="display: none;">
    <div class="card">
      <h2 class="text-center mb-4 animated-text">Connexion</h2>
      <form id="loginForm">
        <div class="mb-3">
          <label class="form-label">Email EPSI/WIS</label>
          <input type="email" class="form-control" id="loginEmail" name="loginEmail" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Mot de passe</label>
          <input type="password" class="form-control" id="loginPassword" name="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-custom w-100">Se connecter</button>
        <a href="#" class="btn btn-outline-light mt-2 w-100" id="registerLink">Pas de compte ? Inscrivez-vous</a>
      </form>
      <div id="loginError" class="error"></div>
    </div>
  </div>

  <div class="container mt-5 section" id="formSection" style="display: none;">
    <div class="card">
      <h2 class="text-center mb-4 animated-text" id="formTitle"></h2>
      <form id="specificForm">
        <div id="formFields"></div>
        <div class="mb-3">
          <label class="form-label">Nouveau mot de passe</label>
          <input type="password" class="form-control" id="newPassword" name="newPassword" required>
          <div id="newpassword_error" class="error"></div>
        </div>
        <div class="mb-3">
          <label class="form-label">Confirmer le mot de passe</label>
          <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
        </div>
        <button type="submit" class="btn btn-custom w-100 mt-3">Soumettre</button>
        <button type="button" class="btn btn-outline-light w-100 mt-2" id="backButton">Retour</button>
        <div id="formError" class="error"></div>
      </form>
    </div>
  </div>

  <div class="container mt-5 section" id="dashboardSection" style="display: none;">
    <div class="card">
      <h2 class="text-center mb-4 animated-text" id="welcomeMessage"></h2>
      <div class="dashboard-band">
        <h4>Votre tableau de bord :</h4>
        <ul id="dashboardStats">
          <li id="userCluster"></li>
          <li id="studentCount"></li>
          <li id="inertiaMetric" style="display: none;"></li>
        </ul>
      </div>
      <div class="dashboard-content" id="dashboardContent"></div>
    </div>
  </div>

  <div class="container mt-5 section" id="profileSection" style="display: none;">
    <div class="card">
      <h2 class="text-center mb-4 animated-text">Profil</h2>
      <div class="profile-initials-container">
        <div id="profileImage" class="profile-initials"></div>
        <div id="profileName" class="profile-name"></div>
        <span id="cameraIcon" class="camera">üì∑</span>
        <input type="file" id="profileUpload" accept="image/*" style="display: none;">
      </div>
      <table class="profile-table" id="profileData"></table>
      <div class="text-center mt-3">
        <button class="btn btn-custom mt-3" id="changeFormation">Changer de formation</button>
        <button class="btn btn-custom mt-3 ms-3" id="editProfile">Modifier</button>
      </div>
    </div>
  </div>

  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <h3 class="text-center">Confirmation</h3>
      <p class="text-center">√ätes-vous s√ªr de vos informations ?</p>
      <button class="btn btn-custom mt-3" id="confirmSubmit">Confirmer</button>
      <button class="btn btn-outline-light mt-3" id="cancelSubmit">Annuler</button>
    </div>
  </div>

  <div id="successMessage" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 class="text-center">Succ√®s</h3>
      <p class="text-center">Votre formulaire a √©t√© soumis avec succ√®s !</p>
      <button class="btn btn-custom mt-3" id="closeSuccess">OK</button>
    </div>
  </div>

  <div id="imageUploadSuccess" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 class="text-center">Succ√®s</h3>
      <p class="text-center">L'image de profil a √©t√© mise √† jour avec succ√®s !</p>
      <button class="btn btn-custom mt-3" id="closeImageUpload">OK</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let userData = JSON.parse(localStorage.getItem('userData')) || {};

    window.onload = function() {
      if (!userData.email || !userData.password) {
        userData = {};
        localStorage.removeItem('userData');
        document.getElementById('header').style.display = 'none';
        document.getElementById('registerSection').style.display = 'block';
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('formSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
      } else {
        validateSession();
      }
    };

    function validateSession() {
      fetch(`http://localhost:5000/validate_session?email=${encodeURIComponent(userData.email)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          document.getElementById('header').style.display = 'flex';
          document.getElementById('registerSection').style.display = 'none';
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('dashboardSection').style.display = 'block';
          loadDashboard();
        } else {
          userData = {};
          localStorage.removeItem('userData');
          document.getElementById('header').style.display = 'none';
          document.getElementById('registerSection').style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Erreur de validation:', error);
        userData = {};
        localStorage.removeItem('userData');
        document.getElementById('header').style.display = 'none';
        document.getElementById('registerSection').style.display = 'block';
      });
    }

    document.getElementById('homeLink').addEventListener('click', function(e) {
      e.preventDefault();
      if (userData.email && userData.password) {
        document.getElementById('profileSection').style.display = 'none';
        loadDashboard();
      } else {
        document.getElementById('registerSection').style.display = 'block';
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
      }
    });

    document.getElementById('profileLink').addEventListener('click', function(e) {
      e.preventDefault();
      if (userData.email && userData.password) {
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'block';
        loadProfile();
      } else {
        document.getElementById('registerSection').style.display = 'block';
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('profileSection').style.display = 'none';
      }
    });

    document.getElementById('loginLink').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('registerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
    });

    document.getElementById('registerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formation = document.getElementById('formation').value;
      const email = document.getElementById('email').value;
      const emailError = document.getElementById('emailError');
      if (!email.endsWith('@ecoles-epsi.net') && !email.endsWith('@ecoles-wis.net')) {
        emailError.textContent = 'Veuillez entrer un email EPSI/WIS valide.';
        return;
      }
      emailError.textContent = '';
      console.log('Envoi de:', { email, formation });
      fetch('http://localhost:5000/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, formation })
      })
      .then(response => {
        console.log('Statut HTTP:', response.status);
        if (!response.ok) {
          return response.json().then(errorData => {
            throw new Error(`R√©ponse non OK: ${response.status} - ${JSON.stringify(errorData)}`);
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          emailError.textContent = data.error;
        } else {
          userData.email = data.email;
          userData.formation = data.formation;
          localStorage.setItem('userData', JSON.stringify(userData));
          document.getElementById('registerSection').style.display = 'none';
          if (data.next === 'form') {
            loadForm();
          }
        }
      })
      .catch(error => {
        console.error('Erreur lors de l\'inscription:', error);
        emailError.textContent = 'Erreur serveur, veuillez r√©essayer. D√©tails : ' + error.message;
      });
    });

    document.getElementById('registerLink').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('registerSection').style.display = 'block';
    });

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const loginEmail = document.getElementById('loginEmail').value;
      const loginPassword = document.getElementById('loginPassword').value;
      fetch('http://localhost:5000/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: loginEmail, password: loginPassword })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('loginError').textContent = data.error;
        } else {
          userData.email = loginEmail;
          userData.password = loginPassword;
          userData.formation = data.formation;
          localStorage.setItem('userData', JSON.stringify(userData));
          document.getElementById('header').style.display = 'flex';
          document.getElementById('loginSection').style.display = 'none';
          if (data.next === 'dashboard') {
            loadDashboard();
          }
        }
      })
      .catch(error => console.error('Erreur:', error));
    });

    function loadForm() {
      const formation = userData.formation || localStorage.getItem('formation_' + userData.email);
      document.getElementById('formTitle').textContent = `Formulaire ${formation}`;
      let fields = {};
      if (formation === 'ASRBD') {
        fields = {
          'Civilit√©': 'select', 'Nom': 'text', 'Pr√©nom': 'text', 'Date_de_Naissance': 'date',
          'Lieu_de_Naissance': 'text', 'D√©partement_de_Naissance': 'text', 'Pays': 'select',
          'Adresse': 'text', 'CP': 'text', 'Ville': 'text', 'Tel_Fixe': 'tel',
          'Tel_Mobile': 'tel', 'Adresse_mail_personnelle': 'email',
          'Dipl√¥me_ou_niveau_d_√©tudes': 'select', 'Exp√©rience_professionnelle': 'select',
          'Dur√©e_de_l_exp√©rience': 'select', 'Financement': 'select'
        };
      } else if (formation === 'EISI' || formation === 'DEVIA') {
        fields = {
          'Civilit√©': 'select', 'ID_Candidat_IGOR': 'text', 'Identifiant_candidat': 'text', 'Campus': 'text',
          'Nom_de_naissance': 'text', 'Pr√©nom': 'text',
          'Date_de_naissance': 'date', 'Code_postal_ville_naissance': 'text',
          'Lieu_de_naissance_ville': 'text', 'Pays_de_naissance': 'select',
          'Nationalit√©': 'text', 'Dernier_dipl√¥me': 'text',
          'Niveau_dernier_diplome': 'select', 'Ann√©e_d_obtention': 'number',
          'D√©cision_du_jury': 'text', 'Ann√©e_de_premi√®re_inscription': 'number',
          'Voie_d_acc√®s': 'text', 'Situation_avant_cursus': 'text',
          'Dernier_m√©tier': 'text', 'Nom_de_l_entreprise': 'text',
          'Dur√©e_de_l_exp√©rience': 'select', 'T√©l√©phone_portable': 'tel',
          'Adresse_mail_personnelle': 'email'
        };
      }
      let fieldsHtml = '';
      fetch(`http://localhost:5000/user_data?email=${encodeURIComponent(userData.email)}`)
        .then(response => response.json())
        .then(data => {
          const formData = data.form;
          for (let field in fields) {
            if (fields[field] === 'select') {
              if (field === 'Civilit√©') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="Monsieur" ${formData[field] === 'Monsieur' ? 'selected' : ''}>Monsieur</option><option value="Madame" ${formData[field] === 'Madame' ? 'selected' : ''}>Madame</option></select></div>`;
              } else if (field === 'Pays' || field === 'Pays_de_naissance') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="France" ${formData[field] === 'France' ? 'selected' : ''}>France</option><option value="C√¥te d'Ivoire" ${formData[field] === 'C√¥te d\'Ivoire' ? 'selected' : ''}>C√¥te d'Ivoire</option><option value="Autre" ${formData[field] === 'Autre' ? 'selected' : ''}>Autre</option></select></div>`;
              } else if (field === 'Dipl√¥me_ou_niveau_d_√©tudes' || field === 'Niveau_dernier_diplome') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="Bac+2" ${formData[field] === 'Bac+2' ? 'selected' : ''}>Bac+2</option><option value="Licence" ${formData[field] === 'Licence' ? 'selected' : ''}>Licence</option><option value="Bachelor" ${formData[field] === 'Bachelor' ? 'selected' : ''}>Bachelor</option><option value="Master" ${formData[field] === 'Master' ? 'selected' : ''}>Master</option><option value="Autre" ${formData[field] === 'Autre' ? 'selected' : ''}>Autre</option></select></div>`;
              } else if (field === 'Exp√©rience_professionnelle') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="D√©butant" ${formData[field] === 'D√©butant' ? 'selected' : ''}>D√©butant</option><option value="Junior" ${formData[field] === 'Junior' ? 'selected' : ''}>Junior</option><option value="Confirm√©" ${formData[field] === 'Confirm√©' ? 'selected' : ''}>Confirm√©</option><option value="Senior" ${formData[field] === 'Senior' ? 'selected' : ''}>Senior</option><option value="Autre" ${formData[field] === 'Autre' ? 'selected' : ''}>Autre</option></select></div>`;
              } else if (field === 'Dur√©e_de_l_exp√©rience') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="0-2 ans" ${formData[field] === '0-2 ans' ? 'selected' : ''}>0-2 ans</option><option value="3-5 ans" ${formData[field] === '3-5 ans' ? 'selected' : ''}>3-5 ans</option><option value="6-10 ans" ${formData[field] === '6-10 ans' ? 'selected' : ''}>6-10 ans</option><option value="10+ ans" ${formData[field] === '10+ ans' ? 'selected' : ''}>10+ ans</option></select></div>`;
              } else if (field === 'Financement') {
                fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><select class="form-control" name="${field}" required><option value="">Choisir</option><option value="Parents" ${formData[field] === 'Parents' ? 'selected' : ''}>Parents</option><option value="Entreprise" ${formData[field] === 'Entreprise' ? 'selected' : ''}>Entreprise</option><option value="Personnel" ${formData[field] === 'Personnel' ? 'selected' : ''}>Personnel</option><option value="Bourse" ${formData[field] === 'Bourse' ? 'selected' : ''}>Bourse</option><option value="Autre" ${formData[field] === 'Autre' ? 'selected' : ''}>Autre</option></select></div>`;
              }
            } else {
              const value = formData[field] || '';
              fieldsHtml += `<div class="mb-3"><label class="form-label">${field}</label><input type="${fields[field]}" class="form-control" name="${field}" value="${value}" ${fields[field] === 'date' ? '' : 'required'}></div>`;
            }
          }
          document.getElementById('formFields').innerHTML = fieldsHtml;
          document.getElementById('formSection').style.display = 'block';
        })
        .catch(error => console.error('Erreur lors du chargement des donn√©es:', error));
    }

    document.getElementById('specificForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      let isValid = true;
      let formData = {};
      form.querySelectorAll('input, select').forEach(input => {
        const errorDiv = document.getElementById(`${input.name}_error`) || document.createElement('div');
        if (!errorDiv.parentElement) {
          errorDiv.className = 'error';
          errorDiv.id = `${input.name}_error`;
          input.parentElement.appendChild(errorDiv);
        }
        errorDiv.textContent = '';
        if (input.hasAttribute('required') && (!input.value || (input.nodeName === 'SELECT' && input.value === ''))) {
          errorDiv.textContent = 'Veuillez remplir ce champ.';
          isValid = false;
        } else {
          formData[input.name] = input.value || '';
        }
      });
      console.log('Donn√©es du formulaire avant validation:', formData);
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      let passwordError = document.getElementById('newpassword_error');
      if (!passwordError) {
        passwordError = document.createElement('div');
        passwordError.className = 'error';
        passwordError.id = 'newpassword_error';
        document.getElementById('newPassword').parentElement.appendChild(passwordError);
      }
      passwordError.textContent = '';
      if (newPassword !== confirmPassword) {
        passwordError.textContent = 'Les mots de passe ne correspondent pas.';
        isValid = false;
      } else if (newPassword.length < 8) {
        passwordError.textContent = 'Le mot de passe doit contenir au moins 8 caract√®res.';
        isValid = false;
      } else {
        formData['Password'] = newPassword;
      }
      if (isValid) {
        document.getElementById('confirmationModal').style.display = 'block';
        window.formData = formData;
        console.log('Donn√©es envoy√©es au serveur:', formData);
      }
    });

    document.getElementById('confirmSubmit').addEventListener('click', function() {
      document.getElementById('confirmationModal').style.display = 'none';
      fetch('http://localhost:5000/submit_form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...window.formData, email: userData.email, formation: userData.formation })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          document.getElementById('formError').textContent = data.error;
        } else {
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('successMessage').style.display = 'block';
          window.formData = {};
          userData = {};
          localStorage.removeItem('userData');
          document.getElementById('header').style.display = 'none';
          document.getElementById('loginSection').style.display = 'block';
        }
      })
      .catch(error => console.error('Erreur:', error));
    });

    document.getElementById('cancelSubmit').addEventListener('click', function() {
      document.getElementById('confirmationModal').style.display = 'none';
    });

    document.getElementById('closeSuccess').addEventListener('click', function() {
      document.getElementById('successMessage').style.display = 'none';
      userData = {};
      localStorage.removeItem('userData');
      document.getElementById('header').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('loginEmail').value = userData.email || '';
    });

    document.getElementById('backButton').addEventListener('click', function() {
      document.getElementById('formSection').style.display = 'none';
      userData = {};
      localStorage.removeItem('userData');
      document.getElementById('header').style.display = 'none';
      document.getElementById('registerSection').style.display = 'block';
      document.getElementById('email').value = userData.email || '';
    });

    function loadDashboard() {
      document.getElementById('dashboardSection').style.display = 'block';
      document.getElementById('registerSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('formSection').style.display = 'none';
      document.getElementById('profileSection').style.display = 'none';
      fetch(`http://localhost:5000/user_data?email=${encodeURIComponent(userData.email)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        const formation = data.formation;
        let dashboardContent = '';
        document.getElementById('welcomeMessage').textContent = `Bienvenue dans la Formation ${formation}`;
        if (formation === 'ASRBD') {
          dashboardContent = `
            <div class="dashboard-band">
              <h4>ASRBD ‚Äì Administration, S√©curit√© des R√©seaux et Base de Donn√©es</h4>
            </div>
            <div class="dashboard-band">
              <h5>Objectifs :</h5>
              <ul>
                <li>Former des administrateurs syst√®mes et r√©seaux capables de g√©rer des infrastructures complexes.</li>
                <li>D√©velopper des comp√©tences en cybers√©curit√© et gestion des bases de donn√©es.</li>
                <li>Pr√©parer aux m√©tiers li√©s √† la maintenance, s√©curit√©, virtualisation, cloud computing et data management.</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h5>Programme type :</h5>
              <ul>
                <li>Syst√®mes d‚Äôexploitation (Linux, Windows Server)</li>
                <li>Administration r√©seaux (TCP/IP, DHCP, DNS, VLAN, routage, firewall‚Ä¶)</li>
                <li>S√©curit√© informatique (chiffrement, attaques, d√©fense, audits‚Ä¶)</li>
                <li>Virtualisation & cloud (VMware, Hyper-V, Azure, AWS‚Ä¶)</li>
                <li>Scripting (PowerShell, Bash)</li>
                <li>Bases de donn√©es (SQL Server, MySQL, Oracle‚Ä¶)</li>
                <li>Sauvegarde, supervision, PRA/PCA</li>
                <li>Mise en place d'infrastructures s√©curis√©es (SIEM, IDS/IPS)</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h4>D√©bouch√©s possibles :</h4>
              <ul>
                <li>Administrateur syst√®mes/r√©seaux, Ing√©nieur s√©curit√©, DevOps, DBA</li>
              </ul>
            </div>
          `;
        } else if (formation === 'DEVIA') {
          dashboardContent = `
            <div class="dashboard-band">
              <h4>DEVIA ‚Äì D√©veloppement Informatique et Intelligence Artificielle</h4>
            </div>
          `;
          // Section pour utilisateurs non-admin : uniquement le nombre d'inscrits
          if (userData.email !== 'admin@ecoles-epsi.net') {
            dashboardContent += `
              <div class="dashboard-band">
                <h5>Informations :</h5>
                <ul id="userStats">
                  <li id="studentCount"></li>
                </ul>
              </div>
            `;
          }
          // Section pour admin : analyse IA compl√®te
          if (userData.email === 'admin@ecoles-epsi.net') {
            dashboardContent += `
              <div class="dashboard-band" id="iaAnalysisSection">
                <h5>Analyse IA (BC01) :</h5>
                <ul id="iaAnalysis"></ul>
                <div id="iaPieChart"></div> <!-- Placeholder pour le pie chart -->
              </div>
            `;
          }
          dashboardContent += `
            <div class="dashboard-band">
              <h5>Objectifs :</h5>
              <ul>
                <li>Former des d√©veloppeurs fullstack sp√©cialis√©s en IA et data science.</li>
                <li>Ma√Ætriser les langages de programmation, le web, les bases de donn√©es et les algorithmes d'IA.</li>
                <li>Comprendre l‚Äô√©thique de l‚ÄôIA, les enjeux du machine learning et du deep learning.</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h5>Programme type :</h5>
              <ul>
                <li>D√©veloppement Web & Mobile (HTML, CSS, JavaScript, React, Node.js‚Ä¶)</li>
                <li>Programmation orient√©e objet (Python, Java, C#‚Ä¶)</li>
                <li>Intelligence Artificielle (r√©gression, classification, r√©seaux de neurones)</li>
                <li>Machine Learning / Deep Learning (scikit-learn, TensorFlow, Keras‚Ä¶)</li>
                <li>Bases de donn√©es (MySQL, PostgreSQL, MongoDB‚Ä¶)</li>
                <li>API et microservices (REST, GraphQL)</li>
                <li>DevOps, int√©gration continue</li>
                <li>Projets IA appliqu√©s (chatbot, analyse pr√©dictive, NLP‚Ä¶)</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h4>D√©bouch√©s possibles :</h4>
              <ul>
                <li>D√©veloppeur fullstack, Data Scientist, Ing√©nieur IA, Data Analyst</li>
              </ul>
            </div>
          `;
        } else if (formation === 'EISI') {
          dashboardContent = `
            <div class="dashboard-band">
              <h4>EISI ‚Äì Expert en Ing√©nierie des Syst√®mes d‚ÄôInformation</h4>
            </div>
            <div class="dashboard-band">
              <h5>Objectifs :</h5>
              <ul>
                <li>Former des experts en architecture SI, capables de piloter des projets complexes.</li>
                <li>Conna√Ætre les enjeux de la transformation digitale, du cloud, de la data et du pilotage SI.</li>
                <li>D√©velopper une approche strat√©gique, technique et manag√©riale.</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h5>Programme type :</h5>
              <ul>
                <li>Architecture des SI (urbanisation, cloud, big data)</li>
                <li>Gouvernance & strat√©gie SI</li>
                <li>Management de projet (Agile, Scrum, Prince2)</li>
                <li>Cybers√©curit√© avanc√©e (audit, normes ISO 27001, RGPD‚Ä¶)</li>
                <li>Business Intelligence & Data Management</li>
                <li>Infrastructure Cloud & Virtualisation</li>
                <li>Innovation & veille technologique</li>
                <li>D√©veloppement d‚Äôapplication √† l‚Äô√©chelle (architecture microservices)</li>
              </ul>
            </div>
            <div class="dashboard-band">
              <h4>D√©bouch√©s possibles :</h4>
              <ul>
                <li>Architecte SI, DSI, Chef de projet IT, Consultant IT, Expert cloud</li>
              </ul>
            </div>
          `;
        }
        document.getElementById('dashboardContent').innerHTML = dashboardContent;

        // Appel √† l'analyse IA uniquement pour admin
        if (formation === 'DEVIA' && userData.email === 'admin@ecoles-epsi.net') {
          fetch('/analyze_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ formation: 'DEVIA' })
          })
          .then(response => response.json())
          .then(analysis => {
            const ul = document.getElementById('iaAnalysis');
            if (analysis.error) {
              ul.innerHTML = `<li>Erreur : ${analysis.error}</li>`;
            } else {
              ul.innerHTML = `
                <li>Cluster assign√© (exemple) : ${analysis.clusters[0] || 'N/A'}</li>
                <li>Inertie (dispersion des clusters) : ${analysis.inertia.toFixed(2) || 'N/A'}</li>
                <li>Score Silhouette (qualit√© du clustering) : ${analysis.silhouette?.toFixed(2) || 'N/A'}</li>
                <li>Statistiques descriptives : ${JSON.stringify(analysis.stats)}</li>
              `;

              // G√©n√©rer un pie chart bas√© sur les stats (uniquement pour admin)
              if (analysis.stats) {
                const stats = analysis.stats;
                const labels = Object.keys(stats);
                const values = Object.values(stats);
                document.getElementById('iaPieChart').innerHTML = ''; // Nettoyer le placeholder
                if (labels.length > 0 && values.length > 0) {
                  const chartCode = {
                    type: 'pie',
                    data: {
                      labels: labels,
                      datasets: [{
                        data: values,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false
                    }
                  };
                  document.getElementById('iaPieChart').innerHTML = `<div style="width: 300px; height: 300px;">${JSON.stringify(chartCode)}</div>`;
                }
              }
            }
          })
          .catch(error => console.error('Erreur lors de l\'analyse IA:', error));
        }

        // Afficher le nombre d'inscrits pour tous (via /student_count)
        fetch(`/student_count?email=${encodeURIComponent(userData.email)}`)
          .then(resp => resp.json())
          .then(countData => {
            const studentCount = countData.count || 0;
            const studentCountElement = document.getElementById('studentCount');
            if (studentCountElement) {
              studentCountElement.textContent = studentCount === 1
                ? `Vous √™tes le premier inscrit dans la formation de ${formation}`
                : `Nombre d'√©tudiants dans votre formation : ${studentCount}`;
            }
          });

        fetch(`/submit_form`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userData.email, formation: formation })
        })
        .then(resp => resp.json())
        .then(result => {
          if (result.cluster !== undefined && userData.email === 'admin@ecoles-epsi.net') {
            document.getElementById('userCluster').textContent = result.cluster === 0 && result.student_count === 1
              ? `Vous √™tes le premier inscrit dans la formation de ${formation}`
              : `Votre cluster : ${result.cluster || 0}`;
          }
          if (result.student_count !== undefined && userData.email === 'admin@ecoles-epsi.net') {
            document.getElementById('studentCount').textContent = result.student_count === 1
              ? `Vous √™tes le premier inscrit dans la formation de ${formation}`
              : `Nombre d'√©tudiants dans votre formation : ${result.student_count}`;
          }
          if (result.inertia !== undefined && userData.email === 'admin@ecoles-epsi.net') {
            document.getElementById('inertiaMetric').style.display = 'block';
            document.getElementById('inertiaMetric').textContent = `Inertie (qualit√© du clustering) : ${result.inertia.toFixed(2)}`;
          }
        });
      })
      .catch(error => console.error('Erreur:', error));
    }

    function loadProfile() {
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('profileSection').style.display = 'block';
      fetch(`http://localhost:5000/user_data?email=${encodeURIComponent(userData.email)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        console.log('Donn√©es re√ßues dans loadProfile:', data);
        const formation = data.formation;
        let fields = {};
        if (formation === 'ASRBD') {
          fields = {
            'Civilit√©': data.form.Civilit√© || 'Non renseign√©', 'Nom': data.form.Nom || 'Non renseign√©', 'Pr√©nom': data.form.Pr√©nom || 'Non renseign√©',
            'Date_de_Naissance': new Date(data.form.Date_de_Naissance).toISOString().split('T')[0] || 'Non renseign√©', 'Lieu_de_Naissance': data.form.Lieu_de_Naissance || 'Non renseign√©',
            'D√©partement_de_Naissance': data.form.D√©partement_de_Naissance || 'Non renseign√©', 'Pays': data.form.Pays || 'Non renseign√©',
            'Adresse': data.form.Adresse || 'Non renseign√©', 'CP': data.form.CP || 'Non renseign√©', 'Ville': data.form.Ville || 'Non renseign√©',
            'Tel_Fixe': data.form.Tel_Fixe || 'Non renseign√©', 'Tel_Mobile': data.form.Tel_Mobile || 'Non renseign√©',
            'Adresse_mail_personnelle': data.form.Adresse_mail_personnelle || 'Non renseign√©',
            'Dipl√¥me_ou_niveau_d_√©tudes': data.form.Dipl√¥me_ou_niveau_d_√©tudes || 'Non renseign√©',
            'Exp√©rience_professionnelle': data.form.Exp√©rience_professionnelle || 'Non renseign√©',
            'Dur√©e_de_l_exp√©rience': data.form.Dur√©e_de_l_exp√©rience || 'Non renseign√©',
            'Financement': data.form.Financement || 'Non renseign√©'
          };
        } else if (formation === 'EISI' || formation === 'DEVIA') {
          fields = {
            'Civilit√©': data.form.Civilit√© || 'Non renseign√©', 'ID_Candidat_IGOR': data.form.ID_Candidat_IGOR || 'Non renseign√©',
            'Identifiant_candidat': data.form.Identifiant_candidat || 'Non renseign√©', 'Campus': data.form.Campus || 'Non renseign√©',
            'Nom_de_naissance': data.form.Nom_de_naissance || 'Non renseign√©', 'Pr√©nom': data.form.Pr√©nom || 'Non renseign√©',
            'Date_de_naissance': new Date(data.form.Date_de_naissance).toISOString().split('T')[0] || 'Non renseign√©', 'Code_postal_ville_naissance': data.form.Code_postal_ville_naissance || 'Non renseign√©',
            'Lieu_de_naissance_ville': data.form.Lieu_de_naissance_ville || 'Non renseign√©', 'Pays_de_naissance': data.form.Pays_de_naissance || 'Non renseign√©',
            'Nationalit√©': data.form.Nationalit√© || 'Non renseign√©', 'Dernier_dipl√¥me': data.form.Dernier_dipl√¥me || 'Non renseign√©',
            'Niveau_dernier_diplome': data.form.Niveau_dernier_diplome || 'Non renseign√©', 'Ann√©e_d_obtention': data.form.Ann√©e_d_obtention || 'Non renseign√©',
            'D√©cision_du_jury': data.form.D√©cision_du_jury || 'Non renseign√©', 'Ann√©e_de_premi√®re_inscription': data.form.Ann√©e_de_premi√®re_inscription || 'Non renseign√©',
            'Voie_d_acc√®s': data.form.Voie_d_acc√®s || 'Non renseign√©', 'Situation_avant_cursus': data.form.Situation_avant_cursus || 'Non renseign√©',
            'Dernier_m√©tier': data.form.Dernier_m√©tier || 'Non renseign√©', 'Nom_de_l_entreprise': data.form.Nom_de_l_entreprise || 'Non renseign√©',
            'Dur√©e_de_l_exp√©rience': data.form.Dur√©e_de_l_exp√©rience || 'Non renseign√©', 'T√©l√©phone_portable': data.form.T√©l√©phone_portable || 'Non renseign√©',
            'Adresse_mail_personnelle': data.form.Adresse_mail_personnelle || 'Non renseign√©'
          };
        }
        let tableHtml = '<thead><tr><th>Informations</th><th>Valeur</th></tr></thead><tbody>';
        for (let field in fields) {
          tableHtml += `<tr><td>${field}</td><td>${fields[field]}</td></tr>`;
        }
        tableHtml += '</tbody>';
        document.getElementById('profileData').innerHTML = tableHtml;

        const prenom = fields['Pr√©nom'] || '';
        const nom = fields['Nom'] || fields['Nom_de_naissance'] || '';
        const initials = (prenom.charAt(0) + (nom.charAt(0) || '')).toUpperCase() || '??';
        document.getElementById('profileImage').textContent = initials.substring(0, 2);
        document.getElementById('profileImageHeader').textContent = initials.substring(0, 2);
        document.getElementById('profileName').textContent = `${prenom} ${nom}`.trim() || 'Inconnu';

        // Gestion de l'upload d'image
        document.getElementById('cameraIcon').addEventListener('click', function() {
          document.getElementById('profileUpload').click();
        });

        document.getElementById('profileUpload').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('profileImage').innerHTML = `<img src="${e.target.result}" alt="Profile Image" class="profile-img">`;
              document.getElementById('profileImageHeader').innerHTML = `<img src="${e.target.result}" alt="Profile Image" style="height: 40px; border-radius: 50%;">`;
            };
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('profile_image', file);
            formData.append('email', userData.email);

            fetch('http://localhost:5000/upload_profile_image', {
              method: 'POST',
              body: formData
            })
            .then(response => {
              if (!response.ok) throw new Error('√âchec de l\'upload');
              return response.json();
            })
            .then(data => {
              if (data.success) {
                document.getElementById('imageUploadSuccess').style.display = 'block';
              } else {
                alert('Erreur : ' + (data.error || 'Upload √©chou√©'));
              }
            })
            .catch(error => {
              console.error('Erreur d\'upload:', error);
              alert('Erreur lors de l\'upload : ' + error.message);
            });
          }
        });

        document.getElementById('closeImageUpload').addEventListener('click', function() {
          document.getElementById('imageUploadSuccess').style.display = 'none';
        });

        document.getElementById('changeFormation').addEventListener('click', function() {
          fetch('http://localhost:5000/change_formation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userData.email, formation: '' })
          })
          .then(response => response.json())
          .then(data => {
            if (data.next === 'form') {
              userData.formation = '';
              localStorage.setItem('userData', JSON.stringify(userData));
              document.getElementById('profileSection').style.display = 'none';
              loadForm();
            }
          })
          .catch(error => console.error('Erreur:', error));
        });
      })
      .catch(error => console.error('Erreur:', error));
    }

    document.getElementById('logout').addEventListener('click', function(e) {
      e.preventDefault();
      userData = {};
      localStorage.removeItem('userData');
      document.getElementById('header').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'none';
      document.getElementById('profileSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      fetch('http://localhost:5000/delete_data?email=' + encodeURIComponent(userData.email), {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => console.log('D√©connexion:', data))
      .catch(error => console.error('Erreur:', error));
    });

    document.getElementById('editProfile').addEventListener('click', function() {
      console.log('Bouton Modifier cliqu√©');
    });
  </script>
</body>
</html>